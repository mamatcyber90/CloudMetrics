---
- name: Launch EC2 instance
  ec2:
    instance_type: "{{ instance_type }}"
    image: "{{image}}"
    wait: true
    region: "{{ region }}"
    keypair: "{{key}}"
    count: "{{count}}"
  register: ec2

- name: Wait for SSH to open
  wait_for:
    host: "{{ item.public_ip }}"
    port: 22
    state: started
  with_items: "{{ ec2.instances }}"

- name: Add name to instances
  ec2_tag:
    resource: "{{ item.id }}"
    region: "{{ region }}"
    state: present
    tags:
      Name: AWS "{{size}}" "{{lookup('pipe','env TZ=America/Chicago date')}}"
  with_items: "{{ ec2.instances }}"
